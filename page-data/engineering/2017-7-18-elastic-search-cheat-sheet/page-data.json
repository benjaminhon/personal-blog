{"componentChunkName":"component---src-templates-blogpost-template-jsx","path":"/engineering/2017-7-18-elastic-search-cheat-sheet/","result":{"data":{"markdownRemark":{"html":"<h1>Elasticsearch Structure</h1>\n<p>An index is a collection of documents that have somewhat similar characteristics. Within an index, you can define one or more types. A document is a basic unit of information that can be indexed.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># &lt;index>/&lt;type>/&lt;document></span>\ncompany/employee/alan\ncompany/intern/steve</code></pre></div>\n<h1>Query Indices</h1>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># Get all indices</span>\n<span class=\"token function\">curl</span> -XGET <span class=\"token string\">'&lt;url>/_cat/indices'</span>\n\n<span class=\"token comment\"># Get all mappings</span>\n<span class=\"token function\">curl</span> -XGET <span class=\"token string\">'&lt;url>/_mapping?pretty=true'</span>\n\n<span class=\"token comment\"># Get and save mapping of index</span>\n<span class=\"token function\">curl</span> -XGET <span class=\"token string\">'&lt;url>/&lt;index>/_mapping?pretty=true'</span> <span class=\"token operator\">></span> mapping.json</code></pre></div>\n<h1>Create Index Mapping Template</h1>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># download mapping</span>\n<span class=\"token function\">curl</span> -XGET <span class=\"token string\">'http://127.0.0.1:9200/&lt;index>/_mapping?pretty'</span> <span class=\"token operator\">></span> template.json</code></pre></div>\n<p>Modify the properties as required in <em>template.json</em>. Then replace <em>template.json</em> as follows, replacing the properties section.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"template\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"my_index*\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"version\"</span> <span class=\"token punctuation\">:</span> <span class=\"token number\">50001</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"settings\"</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"index.refresh_interval\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"5s\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"mappings\"</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"_default_\"</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"properties\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        # <span class=\"token constant\">REPLACE</span> <span class=\"token constant\">PROPERTIES</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># delete index</span>\n<span class=\"token function\">curl</span> -XDELETE <span class=\"token string\">'http://localhost:9200/&lt;index>?pretty'</span>\n\n<span class=\"token comment\"># upload template</span>\n<span class=\"token function\">curl</span> -XPUT <span class=\"token string\">'http://localhost:9200/_template/&lt;index>?pretty'</span> -d @template.json</code></pre></div>\n<h1>Query Data</h1>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># Get all documents in index</span>\nGET /<span class=\"token operator\">&lt;</span>index<span class=\"token operator\">></span>/<span class=\"token operator\">&lt;</span>type<span class=\"token operator\">></span>/_search?q<span class=\"token operator\">=</span>*</code></pre></div>\n<h1>Recipes</h1>\n<h3>Get all unique terms</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token constant\">GET</span> <span class=\"token operator\">/</span>zmq<span class=\"token operator\">/</span>position<span class=\"token operator\">-</span>update<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"size\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> # <span class=\"token keyword\">return</span> only aggregate results\n  <span class=\"token string\">\"aggregations\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"terms\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"field\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"id.keyword\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Get last document in aggregate</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token constant\">GET</span> <span class=\"token operator\">/</span>zmq<span class=\"token operator\">/</span>position<span class=\"token operator\">-</span>update<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"size\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"aggregations\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"terms\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"field\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"id.keyword\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"aggregations\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"latest\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"top_hits\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"size\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"sort\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"@timestamp\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"order\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"desc\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"_source\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"includes\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"location\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"map\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"Elasticsearch Cheat Sheet"},"fields":{"date":1500307200}}},"pageContext":{}}}